<!DOCTYPE html>
<html>
<head>
    <title>Settings</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        label {
            display: inline-block;
            width: 200px;
            vertical-align: top;
        }
        input[type="text"] {
            width: 300px;
        }
        .section {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            padding: 15px;
        }
        .subsection {
            margin-bottom: 15px;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <h1>Settings</h1>
    {% if error %}
      <p style="color:red;">{{ error }}</p>
    {% endif %}
    <form method="POST">
      
      <!-- AWS Settings -->
      <div class="section">
          <h2>AWS Settings</h2>
          <label for="aws_access_key_id">Access Key ID:</label>
          <input type="text" id="aws_access_key_id" name="aws_access_key_id" value="{{ config.aws.access_key_id or '' }}"><br><br>
          
          <label for="aws_secret_access_key">Secret Access Key:</label>
          <input type="text" id="aws_secret_access_key" name="aws_secret_access_key" value="{{ config.aws.secret_access_key or '' }}"><br><br>
          
          <label for="aws_region_name">Region Name:</label>
          <input type="text" id="aws_region_name" name="aws_region_name" value="{{ config.aws.region_name or '' }}"><br><br>
      </div>
      
      <!-- Scryfall Settings -->
      <div class="section">
          <h2>Scryfall Settings</h2>
          <label for="scryfall_search_url">Scryfall Search URL:</label>
          <input type="text" id="scryfall_search_url" name="scryfall_search_url" value="{{ config.scryfall_search_url or '' }}"><br><br>
      </div>
      
      <!-- Flappers Settings -->
      <div class="section">
          <h2>Flappers Settings</h2>
          {% for flapper, settings in config.flappers.items() %}
            <div class="subsection">
                <h3>{{ flapper|replace('_', ' ')|title }}</h3>
                <label for="{{ flapper }}_open_degrees">Open Degrees:</label>
                <input type="text" id="{{ flapper }}_open_degrees" name="{{ flapper }}_open_degrees" value="{{ settings.open_degrees or '' }}"><br><br>
                
                <label for="{{ flapper }}_close_degrees">Close Degrees:</label>
                <input type="text" id="{{ flapper }}_close_degrees" name="{{ flapper }}_close_degrees" value="{{ settings.close_degrees or '' }}"><br><br>
                
                <!-- Test Button for each flapper -->
                <button type="button" onclick="testFlapper('{{ flapper }}')">Test {{ flapper|replace('_', ' ')|title }}</button>
            </div>
          {% endfor %}
      </div>
      
      <!-- Card Servo Settings -->
      <div class="section">
          <h2>Card Servo Settings</h2>
          <label for="card_servo_open_degrees">Open Degrees:</label>
          <input type="text" id="card_servo_open_degrees" name="card_servo_open_degrees" value="{{ config.card_servo.open_degrees or '' }}"><br><br>
          
          <label for="card_servo_close_degrees">Close Degrees:</label>
          <input type="text" id="card_servo_close_degrees" name="card_servo_close_degrees" value="{{ config.card_servo.close_degrees or '' }}"><br><br>
          
          <!-- Test Button for card servo -->
          <button type="button" onclick="testCardServo()">Test Card Servo</button>
      </div>
      
      <button type="submit" name="save">Save</button>
      <button type="submit" name="cancel">Cancel</button>
    </form>
    
    <script>
        // Helper function to call the server endpoint to run a script
        function runScript(scriptName) {
            fetch(`/run_script?script=${encodeURIComponent(scriptName)}`)
                .then(response => response.text())
                .then(data => console.log(`Script ${scriptName} executed:`, data))
                .catch(error => console.error(`Error running ${scriptName}:`, error));
        }

        // Function to test a flapper by triggering its open then closed script with a 2-second delay.
        function testFlapper(flapperName) {
            const baseName = flapperName.replace('flapper_', 'Flapper-');
            const openScript = `scripts/${baseName}_Open.py`;
            const closeScript = `scripts/${baseName}_Closed.py`;
            runScript(openScript);
            setTimeout(function() {
                runScript(closeScript);
            }, 2000);
        }

        // Function to test the card servo
        function testCardServo() {
            runScript("scripts/Card-Release.py");
            setTimeout(function() {
                runScript("scripts/Card-Capture.py");
            }, 2000);
        }
    </script>
</body>
</html>
